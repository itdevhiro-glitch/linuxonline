<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garuda Linux WebOS</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Fira+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- SYSTEM CORE STYLES --- */
        :root {
            --bg-color: #0f0f15;
            --win-bg: rgba(20, 21, 27, 0.90);
            --win-border: rgba(255, 255, 255, 0.15);
            --blur: 20px;
            --primary: #c95690;
            --accent: #00d6de;
            --text: #e1e1e1;
            --term-red: #ff5555;
            --term-green: #50fa7b;
            --font-ui: 'Fira Sans', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; user-select: none; outline: none; }
        body { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; background-color: #000; font-family: var(--font-ui); color: var(--text); }

        /* BOOT SCREEN */
        #boot-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; font-family: var(--font-mono); transition: opacity 0.5s; }
        .boot-log { width: 80%; max-width: 600px; text-align: left; font-size: 14px; color: #aaa; margin-top: 20px; display: none; }
        .log-line { margin: 2px 0; }
        .log-ok { color: var(--term-green); font-weight: bold; }
        .log-warn { color: #f1fa8c; font-weight: bold; }

        /* DESKTOP */
        #desktop { width: 100%; height: 100%; background: url('https://raw.githubusercontent.com/zhichaoh/catppuccin-wallpapers/main/landscapes/forrest.png') center/cover no-repeat; position: relative; display: none; opacity: 0; transition: opacity 1s; }
        
        /* TOP BAR */
        #top-bar { position: absolute; top: 0; left: 0; width: 100%; height: 30px; background: rgba(15, 15, 20, 0.6); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; padding: 0 10px; z-index: 5000; font-size: 13px; }
        .bar-left, .bar-right { display: flex; gap: 15px; align-items: center; }
        .launcher-btn { color: var(--accent); font-size: 16px; cursor: pointer; padding: 2px 8px; }

        /* WINDOWS */
        .window { position: absolute; min-width: 400px; min-height: 300px; background: var(--win-bg); backdrop-filter: blur(var(--blur)); border-radius: 10px; border: 1px solid var(--win-border); box-shadow: 0 0 0 1px rgba(255,255,255,0.05), 0 10px 40px rgba(0,0,0,0.5); display: flex; flex-direction: column; opacity: 0; transform: scale(0.9); transition: opacity 0.2s, transform 0.2s; overflow: hidden; }
        .window.open { opacity: 1; transform: scale(1); }
        .window.active { z-index: 100; border-color: rgba(201, 86, 144, 0.4); box-shadow: 0 0 0 1px rgba(201, 86, 144, 0.4), 0 15px 50px rgba(0,0,0,0.6); }
        .window.minimized { opacity: 0; transform: scale(0.5) translateY(500px); pointer-events: none; transition: 0.4s; }
        .title-bar { height: 35px; background: rgba(255,255,255,0.03); display: flex; justify-content: space-between; align-items: center; padding: 0 12px; cursor: grab; }
        .title-bar:active { cursor: grabbing; }
        .win-content { flex: 1; overflow: hidden; position: relative; display: flex; flex-direction: column; }
        .win-controls { display: flex; gap: 8px; }
        .ctrl-btn { width: 12px; height: 12px; border-radius: 50%; cursor: pointer; }
        .close { background: #ff5555; } .min { background: #f1fa8c; } .max { background: #50fa7b; }

        /* DOCK */
        #dock-container { position: absolute; bottom: 15px; width: 100%; display: flex; justify-content: center; z-index: 5000; }
        #dock { background: rgba(20, 20, 25, 0.8); backdrop-filter: blur(20px); padding: 8px 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); display: flex; gap: 10px; align-items: flex-end; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .dock-item { width: 48px; height: 48px; border-radius: 12px; background: rgba(255,255,255,0.05); display: flex; justify-content: center; align-items: center; font-size: 1.5rem; cursor: pointer; transition: all 0.2s; position: relative; color: #fff; }
        .dock-item:hover { transform: scale(1.2) translateY(-10px); background: rgba(255,255,255,0.15); }
        .dock-item.running::after { content: ''; position: absolute; bottom: -6px; width: 6px; height: 6px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 5px var(--accent); }

        /* APP SPECIFIC */
        .terminal-wrap { padding: 10px; font-family: 'JetBrains Mono'; font-size: 13px; height: 100%; overflow-y: auto; color: var(--text); background: rgba(10, 10, 15, 0.95); cursor: text; }
        .cmd-line { display: flex; margin-top: 5px; }
        .cmd-input { background: transparent; border: none; color: #fff; font-family: inherit; font-size: inherit; flex: 1; margin-left: 8px; }
        .dolphin-view { flex: 1; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); grid-auto-rows: 110px; gap: 10px; overflow-y: auto; }
        .file-item { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 10px; border-radius: 8px; cursor: pointer; text-align: center; }
        .file-item:hover { background: rgba(255,255,255,0.1); }
        .file-item.selected { background: rgba(201, 86, 144, 0.3); border: 1px solid rgba(201, 86, 144, 0.5); }
        .file-icon { font-size: 2.5rem; }
        .kate-editor { width: 100%; height: 100%; background: #1e1e2e; color: #cdd6f4; border: none; padding: 15px; font-family: var(--font-mono); resize: none; font-size: 14px; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="boot-screen">
        <i class="fas fa-dragon fa-3x" style="color:var(--primary); margin-bottom: 20px; animation: pulse 2s infinite;"></i>
        <div style="font-weight: 700; font-size: 24px;">GARUDA <span style="color:var(--accent)">WEB</span></div>
        <div class="boot-log" id="boot-log"></div>
    </div>

    <div id="desktop">
        <div id="top-bar">
            <div class="bar-left"><div class="launcher-btn" onclick="Apps.launch('terminal')"><i class="fas fa-dragon"></i></div><div id="global-menu" style="font-weight: 600;">Desktop</div></div>
            <div class="bar-right"><div id="clock" style="font-weight:600; font-family: var(--font-mono);">12:00</div></div>
        </div>
        <div id="window-area" style="position:absolute; top:30px; bottom:0; width:100%;"></div>
        <div id="dock-container">
            <div id="dock">
                <div class="dock-item" onclick="Apps.launch('terminal')" title="Alacritty"><i class="fas fa-terminal" style="color:#50fa7b"></i></div>
                <div class="dock-item" onclick="Apps.launch('dolphin')" title="Dolphin"><i class="fas fa-folder-open" style="color:#8be9fd"></i></div>
                <div class="dock-item" onclick="Apps.launch('kate')" title="Kate"><i class="fas fa-pen" style="color:#ffb86c"></i></div>
                <div class="dock-item" onclick="location.reload()" title="Reboot"><i class="fas fa-power-off" style="color:#ff5555"></i></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIG FIREBASE LU (Sesuai Request)
        const firebaseConfig = {
            apiKey: "AIzaSyDxZvpKrQ236bCTOLSzoMrHRR8BINTI-Sw",
            authDomain: "atlantiscorp-af211.firebaseapp.com",
            databaseURL: "https://atlantiscorp-af211-default-rtdb.firebaseio.com",
            projectId: "atlantiscorp-af211",
            storageBucket: "atlantiscorp-af211.firebasestorage.app",
            messagingSenderId: "36612462515",
            appId: "1:36612462515:web:7683c3b686d308450addc6",
            measurementId: "G-NE54KLXY3Z"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db);
        
        // UTILS
        const logEl = document.getElementById('boot-log');
        const log = (msg, type='OK') => {
            logEl.style.display = 'block';
            const color = type === 'OK' ? 'log-ok' : 'log-warn';
            logEl.innerHTML += `<div class="log-line">[ <span class="${color}">${type}</span> ] ${msg}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        };

        // --- FILESYSTEM SYSTEM (FS) ---
        const FS = {
            data: {},
            async init() {
                try {
                    log("Connecting to Firebase...");
                    const snapshot = await get(child(dbRef, 'filesystem'));
                    if (snapshot.exists()) {
                        this.data = snapshot.val();
                        log("Cloud Data Loaded.");
                    } else {
                        log("No data found. Creating default...", "WARN");
                        this.reset();
                    }
                } catch (error) {
                    console.error("Firebase Error:", error);
                    log("Connection Failed (Check Console)", "ERR");
                    // Fallback biar tetep jalan walau error
                    this.data = JSON.parse(localStorage.getItem('garuda_fallback')) || {};
                    if(Object.keys(this.data).length === 0) this.reset(true); 
                }
            },
            reset(localOnly = false) {
                this.data = {
                    '/': { type: 'dir', children: ['home'] },
                    '/home': { type: 'dir', children: ['garuda'] },
                    '/home/garuda': { type: 'dir', children: ['readme.txt'] },
                    '/home/garuda/readme.txt': { type: 'file', content: 'Welcome to Garuda Web OS via GitHub!' }
                };
                if(!localOnly) this.save();
            },
            save() {
                set(ref(db, 'filesystem'), this.data).catch(e => console.warn("Save failed:", e));
            },
            // CRUD Simplified
            getNode(path) { if(path.length > 1 && path.endsWith('/')) path = path.slice(0, -1); return this.data[path] || null; },
            ls(path) { const n = this.getNode(path); return (n && n.type === 'dir') ? n.children : null; },
            mkdir(path, name) { 
                const full = path === '/' ? '/'+name : path+'/'+name;
                if(this.data[full]) return false;
                const parent = this.getNode(path);
                if(parent) { parent.children.push(name); this.data[full] = {type:'dir', children:[]}; this.save(); return true; }
                return false;
            },
            touch(path, name, content='') {
                const full = path === '/' ? '/'+name : path+'/'+name;
                const parent = this.getNode(path);
                if(parent) { if(!parent.children.includes(name)) parent.children.push(name); this.data[full] = {type:'file', content}; this.save(); return true; }
                return false;
            },
            rm(path, name) {
                const full = path === '/' ? '/'+name : path+'/'+name;
                const parent = this.getNode(path);
                if(parent) { parent.children = parent.children.filter(x => x !== name); delete this.data[full]; this.save(); return true; }
                return false;
            }
        };

        // --- WINDOW MANAGER (WM) ---
        const WM = {
            windows: [], zIndex: 100, dragTarget: null, dragOff: {x:0, y:0},
            init() {
                window.addEventListener('mousemove', e => {
                    if(this.dragTarget) {
                        const el = document.getElementById(this.dragTarget);
                        el.style.left = (e.clientX - this.dragOff.x) + 'px';
                        el.style.top = (e.clientY - this.dragOff.y) + 'px';
                    }
                });
                window.addEventListener('mouseup', () => { this.dragTarget = null; });
            },
            create(cfg) {
                const id = 'win-' + Date.now();
                this.zIndex++;
                const el = document.createElement('div');
                el.className = 'window open active'; el.id = id;
                el.style.zIndex = this.zIndex; el.style.width = '600px'; el.style.height = '400px';
                el.style.left = (50 + Math.random()*50) + 'px'; el.style.top = (50 + Math.random()*50) + 'px';
                el.innerHTML = `
                    <div class="title-bar" onmousedown="WM.drag(event, '${id}')">
                        <div style="font-weight:600; font-size:13px;">${cfg.icon||''} ${cfg.title}</div>
                        <div class="win-controls"><div class="ctrl-btn min" onclick="WM.min('${id}')"></div><div class="ctrl-btn max"></div><div class="ctrl-btn close" onclick="WM.close('${id}')"></div></div>
                    </div>
                    <div class="win-content">${cfg.content}</div>`;
                el.onmousedown = () => WM.focus(id);
                document.getElementById('window-area').appendChild(el);
                this.windows.push({id, app:cfg.app});
                if(cfg.onLoad) cfg.onLoad(id);
            },
            focus(id) { const el = document.getElementById(id); if(el) { el.style.zIndex = ++this.zIndex; document.querySelectorAll('.window').forEach(w=>w.classList.remove('active')); el.classList.add('active'); } },
            close(id) { const el = document.getElementById(id); if(el) { el.remove(); this.windows = this.windows.filter(w=>w.id!==id); } },
            min(id) { document.getElementById(id).classList.add('minimized'); document.getElementById(id).classList.remove('open'); },
            drag(e, id) { 
                if(e.target.closest('.win-controls')) return;
                this.dragTarget = id; this.focus(id); 
                const rect = document.getElementById(id).getBoundingClientRect();
                this.dragOff = {x: e.clientX - rect.left, y: e.clientY - rect.top};
            }
        };

        // --- APPS ---
        const Apps = {
            launch(app) {
                if(app === 'terminal') this.term();
                if(app === 'dolphin') this.dolphin('/home/garuda');
                if(app === 'kate') this.kate();
            },
            term() {
                let cwd = '/home/garuda';
                WM.create({
                    title: 'Alacritty', app: 'terminal', icon: '<i class="fas fa-terminal"></i>',
                    content: `<div class="terminal-wrap" onclick="this.querySelector('input').focus()">
                        <div class="out">Garuda Cloud Shell (GitHub Edition)</div>
                        <div class="cmd-line" style="margin-top:5px"><span style="color:#ff5555">garuda</span>@<span style="color:#bd93f9">cloud</span> <span style="color:#8be9fd">~</span> ➜ <input class="cmd-input"></div>
                    </div>`,
                    onLoad: (id) => {
                        const win = document.getElementById(id);
                        const inp = win.querySelector('input');
                        const out = win.querySelector('.out');
                        inp.focus();
                        inp.onkeydown = (e) => {
                            if(e.key === 'Enter') {
                                const val = inp.value.trim();
                                out.innerHTML += `<div>➜ ${val}</div>`;
                                if(val === 'ls') out.innerHTML += (FS.ls(cwd)||[]).join('  ') || 'Empty';
                                else if(val.startsWith('mkdir ')) FS.mkdir(cwd, val.split(' ')[1]);
                                else if(val.startsWith('touch ')) FS.touch(cwd, val.split(' ')[1]);
                                else if(val.startsWith('rm ')) FS.rm(cwd, val.split(' ')[1]);
                                else if(val === 'clear') out.innerHTML = '';
                                else if(val === 'help') out.innerHTML = 'Available: ls, mkdir, touch, rm, clear';
                                inp.value = '';
                                win.querySelector('.terminal-wrap').scrollTop = 9999;
                            }
                        }
                    }
                });
            },
            dolphin(path) {
                WM.create({
                    title: 'Dolphin', app: 'dolphin', icon: '<i class="fas fa-folder"></i>',
                    content: `<div class="dolphin-view" id="view-${Date.now()}"></div>`,
                    onLoad: (id) => {
                        const render = () => {
                            const view = document.getElementById(id).querySelector('.dolphin-view');
                            view.innerHTML = '';
                            const files = FS.ls(path) || [];
                            files.forEach(f => {
                                const isDir = FS.getNode(path==='/'?'/'+f:path+'/'+f).type === 'dir';
                                view.innerHTML += `<div class="file-item" onclick="this.classList.toggle('selected')">
                                    <i class="fas ${isDir?'fa-folder':'fa-file'} file-icon" style="color:${isDir?'#8be9fd':'#fff'}"></i>
                                    <div style="font-size:12px">${f}</div>
                                </div>`;
                            });
                        };
                        render();
                        // Auto refresh simple hack
                        setInterval(render, 2000); 
                    }
                });
            },
            kate() {
                WM.create({
                    title: 'Kate', app: 'kate', icon: '<i class="fas fa-pen"></i>',
                    content: `<textarea class="kate-editor">Wait for feature update...</textarea>`
                });
            }
        };

        // EXPOSE
        window.WM = WM; window.Apps = Apps;

        // BOOT
        window.onload = async () => {
            WM.init();
            log("Initializing System...");
            await FS.init();
            log("Starting Desktop Environment...");
            setTimeout(() => {
                document.getElementById('boot-screen').style.opacity = 0;
                setTimeout(() => {
                    document.getElementById('boot-screen').style.display = 'none';
                    document.getElementById('desktop').style.display = 'block';
                    setTimeout(() => document.getElementById('desktop').style.opacity = 1, 100);
                    Apps.launch('terminal');
                }, 500);
            }, 1000);
            setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit'}), 1000);
        };
    </script>
</body>
</html>
